---
title: "Complexes"
author: "Zhang Muyuan"
date: "`r Sys.Date()`"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

These are the complexes that are significantly close to the parameters of interest. The parameters include `eta`, `epsilon`, `xc`, and `scaling`. The complexes are identified based on the p-values from the HARD and SOFT enrichment methods.

For HARD enrichment, each gene is classified into the corresponding category based on the relative distance of its position from the nearest curve. The significance of enrichment is based on the hypergeometric distribution, namely, the p-value is calculated as the probability of observing at least as many genes in the category as observed, given the total number of genes in the category and the total number of genes in the genome.

For soft enrichment, each gene has a four-dimensional feature vector based on the relative distance of the closest point to each curve. For each complex, by summing up the characteristics of all genes, a four-dimensional feature vector of each complex is obtained. By randomly selecting the corresponding number of genes from all the genes, a four-dimensional vector is also calculated. The value of the p-value represents the proportion of complex true eigenvalues that are smaller than those obtained through random sampling.

```{r load_data, echo=FALSE, message=FALSE, warning=FALSE}
# make new directory and set it as working directory
if(!dir.exists("./data/")){
  dir.create("./data/")
}
setwd("./data/")
library(openxlsx)
library(ggplot2)
library(ggnewscale)
library(ggforce)
library(DT)

# fetch files from GitHub
url_1 <- "https://raw.githubusercontent.com/370126/yeast_aging/main/data/complex_df_with_p_values.xlsx"
url_2 <- "https://raw.githubusercontent.com/370126/yeast_aging/main/data/lifes_set_alpha_complex.xlsx"
url_3 <- "https://raw.githubusercontent.com/370126/yeast_aging/main/data/simu_long.csv"
download.file(url_1, destfile = "complex_df_with_p_values.xlsx", mode = "wb", method = "libcurl")
download.file(url_2, destfile = "lifes_set_alpha_complex.xlsx", mode = "wb", method = "libcurl")
download.file(url_3, destfile = "simu_long.csv", mode = "wb", method = "libcurl")

complex_df=read.xlsx("complex_df_with_p_values.xlsx")
# round numeric columns to 4 decimal places
complex_df[sapply(complex_df, is.numeric)] <- round(complex_df[sapply(complex_df, is.numeric)], 4)
# get complex URL
url_base="https://www.ebi.ac.uk/complexportal/complex/"
complex_df$Complex_URL=paste0(url_base,complex_df$Complex_ac)
# reorder columns to have Complex_ac and Complex_URL at the front
complex_df <- complex_df[, c("Complex_ac", "Complex_URL", setdiff(names(complex_df), c("Complex_ac", "Complex_URL")))]

lifes_set_alpha_complex_df=read.xlsx("lifes_set_alpha_complex.xlsx")
simu_long=read.csv("simu_long.csv")
eta_x <- function(x){
  (1183*exp(-(969*x)/400))/625 + (12287*exp(-(3899*x)/10000))/10000
}

epsilon_x <- function(x){
  (1087*exp((14357*x)/10000))/5000 + (672625547621055*exp((3917540578361239*x)/281474976710656))/9444732965739290427392
}

xc_x <- function(x){
  (3089*x^(131/80))/5000 + 247/625
}
```

## Complexes Significantly Close to Specific Parameter

This section allows you to explore the complexes that are significantly close to a specific parameter. You can select the parameter of interest, the enrichment method, and the critical p-value to filter the complexes.

```{r echo=FALSE}


ui <- fluidPage(
  titlePanel("Complexes Analysis"),
  sidebarLayout(
    sidebarPanel(
      selectInput("parameters", "Complexes significantly close to the parameter:",
                  choices = c("eta", "epsilon", "xc", "scaling"), selected = "eta"),
      selectInput("method", "Enrichment method:",
                  choices = c("HARD", "SOFT"), selected = "SOFT"),
      sliderInput("p_critical", "Critical p-value:",
                  min = 0, max = 1, value = 0.05, step = 0.01)
    ),
    mainPanel(
      plotOutput("plot"),
      DTOutput("roi_table")
    )
  )
)

server <- function(input, output, session) {
  
  # 过滤显著 complex 的数据
  df_ROI <- reactive({
    colname <- paste(input$method, "_", input$parameters, "_p", sep = "")
    subset(complex_df, complex_df[[colname]] < as.numeric(input$p_critical))
  })
  
  output$plot <- renderPlot({
    ac_seq <- df_ROI()$Complex_ac
    
    ggplot(data.frame(x = seq(0, 2, length.out = 1000)), aes(x = x)) +
      geom_hline(yintercept = 1, color = "black", linewidth = 0.3) +
      geom_line(aes(y = eta_x(x)), size = 0.3) +
      geom_line(aes(y = epsilon_x(x)), size = 0.3) +
      geom_line(aes(y = xc_x(x)), size = 0.3) +
      geom_point(data = simu_long, aes(x = lifespan_rela, y = steepness_rela, color = para), size = 0.5) +
      scale_color_brewer(palette = "Set2", name = "Parameters") +
      new_scale_color() +
      geom_mark_hull(
        data = subset(lifes_set_alpha_complex_df, complex %in% ac_seq),
        aes(x = lifespan_rela, y = steepness_rela, color = complex, group = complex, fill = complex),
        alpha = 0.2, colour = NA, expand = 0.03, show.legend = FALSE
      ) +
      geom_point(
        data = subset(lifes_set_alpha_complex_df, complex %in% ac_seq),
        aes(x = lifespan_rela, y = steepness_rela, color = complex),
        alpha = 1
      ) +
      xlim(0, 2) + ylim(0.2, 3.5) +
      theme(legend.position = "none") +
      labs(
        x = "Lifespan Relative to WT", 
        y = "Steepness Relative to WT",
        title = paste(input$parameters, ": complexes with p-value < ", input$p_critical, sep = "")
      ) +
      theme_minimal()
  })
  
  output$roi_table <- renderDT({
    datatable(df_ROI())
  })
}

shinyApp(ui, server)


```
